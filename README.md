# Abex-Infr CDK
This is the CDK code for the infra setup of Abex Platform

## Useful commands

* `npm run build`   compile typescript to js
* `npm run watch`   watch for changes and compile
* `npm run test`    perform the jest unit tests
* `cdk deploy`      deploy this stack to your default AWS account/region
* `cdk diff`        compare deployed stack with current state
* `cdk synth`       emits the synthesized CloudFormation template


## How to setup?
1. Install the AWS CLI and CDK CLI on your local machine, if you haven't already.
2. Create a new directory for your CDK project and navigate to it in your terminal.
3. Initialize a new CDK project by running cdk init app --language typescript.
4. Install the necessary dependencies by running npm install @aws-cdk/aws-ecs @aws-cdk/aws-ecs-patterns @aws-cdk/aws-ec2 @aws-cdk/aws-rds.
5. Open the lib/your-stack-name-stack.ts file generated by CDK and start writing your infrastructure code.
6. Once you have written your infrastructure code, you can use the cdk synth command to generate a CloudFormation template for your stack.
7. After reviewing the CloudFormation template, you can deploy your stack by running cdk deploy. This will create all the necessary resources in your AWS account.
8. Wait for the deployment to complete, then test your infrastructure to ensure it's working as expected.


## Synth Output
```
Resources:
  FlagrVpc7D9A1759:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/Resource
  FlagrVpcPublicSubnet1SubnetA8AAC09A:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.0.0/18
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet1
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/Subnet
  FlagrVpcPublicSubnet1RouteTable07E6761D:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet1
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/RouteTable
  FlagrVpcPublicSubnet1RouteTableAssociation27590502:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: FlagrVpcPublicSubnet1RouteTable07E6761D
      SubnetId:
        Ref: FlagrVpcPublicSubnet1SubnetA8AAC09A
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/RouteTableAssociation
  FlagrVpcPublicSubnet1DefaultRouteF89EF665:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: FlagrVpcPublicSubnet1RouteTable07E6761D
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: FlagrVpcIGW5D3D5E95
    DependsOn:
      - FlagrVpcVPCGW7010BABE
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/DefaultRoute
  FlagrVpcPublicSubnet1EIP7BEDBA2B:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet1
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/EIP
  FlagrVpcPublicSubnet1NATGatewayDCBD3435:
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId:
        Ref: FlagrVpcPublicSubnet1SubnetA8AAC09A
      AllocationId:
        Fn::GetAtt:
          - FlagrVpcPublicSubnet1EIP7BEDBA2B
          - AllocationId
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet1
    DependsOn:
      - FlagrVpcPublicSubnet1DefaultRouteF89EF665
      - FlagrVpcPublicSubnet1RouteTableAssociation27590502
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet1/NATGateway
  FlagrVpcPublicSubnet2SubnetA0A535ED:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.64.0/18
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet2
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/Subnet
  FlagrVpcPublicSubnet2RouteTable33B3CADB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet2
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/RouteTable
  FlagrVpcPublicSubnet2RouteTableAssociationAB67B60B:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: FlagrVpcPublicSubnet2RouteTable33B3CADB
      SubnetId:
        Ref: FlagrVpcPublicSubnet2SubnetA0A535ED
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/RouteTableAssociation
  FlagrVpcPublicSubnet2DefaultRouteAE600C29:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: FlagrVpcPublicSubnet2RouteTable33B3CADB
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: FlagrVpcIGW5D3D5E95
    DependsOn:
      - FlagrVpcVPCGW7010BABE
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/DefaultRoute
  FlagrVpcPublicSubnet2EIPF38854F5:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet2
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/EIP
  FlagrVpcPublicSubnet2NATGateway5E9A11F3:
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId:
        Ref: FlagrVpcPublicSubnet2SubnetA0A535ED
      AllocationId:
        Fn::GetAtt:
          - FlagrVpcPublicSubnet2EIPF38854F5
          - AllocationId
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PublicSubnet2
    DependsOn:
      - FlagrVpcPublicSubnet2DefaultRouteAE600C29
      - FlagrVpcPublicSubnet2RouteTableAssociationAB67B60B
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PublicSubnet2/NATGateway
  FlagrVpcPrivateSubnet1Subnet8C355231:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.128.0/18
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Private
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PrivateSubnet1
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet1/Subnet
  FlagrVpcPrivateSubnet1RouteTable991D3671:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PrivateSubnet1
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet1/RouteTable
  FlagrVpcPrivateSubnet1RouteTableAssociation80ADB1AE:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: FlagrVpcPrivateSubnet1RouteTable991D3671
      SubnetId:
        Ref: FlagrVpcPrivateSubnet1Subnet8C355231
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet1/RouteTableAssociation
  FlagrVpcPrivateSubnet1DefaultRoute256E2B89:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: FlagrVpcPrivateSubnet1RouteTable991D3671
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: FlagrVpcPublicSubnet1NATGatewayDCBD3435
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet1/DefaultRoute
  FlagrVpcPrivateSubnet2SubnetD5FF51AE:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.192.0/18
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Private
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PrivateSubnet2
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet2/Subnet
  FlagrVpcPrivateSubnet2RouteTableCAA41A7B:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc/PrivateSubnet2
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet2/RouteTable
  FlagrVpcPrivateSubnet2RouteTableAssociationD32D500E:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: FlagrVpcPrivateSubnet2RouteTableCAA41A7B
      SubnetId:
        Ref: FlagrVpcPrivateSubnet2SubnetD5FF51AE
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet2/RouteTableAssociation
  FlagrVpcPrivateSubnet2DefaultRoute0ADBBDDF:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: FlagrVpcPrivateSubnet2RouteTableCAA41A7B
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: FlagrVpcPublicSubnet2NATGateway5E9A11F3
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/PrivateSubnet2/DefaultRoute
  FlagrVpcIGW5D3D5E95:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: AbexInfraStack/FlagrVpc
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/IGW
  FlagrVpcVPCGW7010BABE:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: FlagrVpc7D9A1759
      InternetGatewayId:
        Ref: FlagrVpcIGW5D3D5E95
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/VPCGW
  FlagrVpcRestrictDefaultSecurityGroupCustomResourceC8AB40AF:
    Type: Custom::VpcRestrictDefaultSG
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomVpcRestrictDefaultSGCustomResourceProviderHandlerDC833E5E
          - Arn
      DefaultSecurityGroupId:
        Fn::GetAtt:
          - FlagrVpc7D9A1759
          - DefaultSecurityGroup
      Account:
        Ref: AWS::AccountId
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrVpc/RestrictDefaultSecurityGroupCustomResource/Default
  CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: Inline
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:RevokeSecurityGroupEgress
                Resource:
                  - Fn::Join:
                      - ""
                      - - "arn:"
                        - Ref: AWS::Partition
                        - ":ec2:"
                        - Ref: AWS::Region
                        - ":"
                        - Ref: AWS::AccountId
                        - :security-group/
                        - Fn::GetAtt:
                            - FlagrVpc7D9A1759
                            - DefaultSecurityGroup
    Metadata:
      aws:cdk:path: AbexInfraStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Role
  CustomVpcRestrictDefaultSGCustomResourceProviderHandlerDC833E5E:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: e77031893275c08bcaa0a774aa8b611727afd045b3b5d8e1e6f0f04063d9d386.zip
      Timeout: 900
      MemorySize: 128
      Handler: __entrypoint__.handler
      Role:
        Fn::GetAtt:
          - CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0
          - Arn
      Runtime: nodejs16.x
      Description: Lambda function for removing all inbound/outbound rules from the VPC default security group
    DependsOn:
      - CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0
    Metadata:
      aws:cdk:path: AbexInfraStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Handler
      aws:asset:path: asset.e77031893275c08bcaa0a774aa8b611727afd045b3b5d8e1e6f0f04063d9d386
      aws:asset:property: Code
  EC2SecurityGroup05DEE054:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: AbexInfraStack/EC2SecurityGroup
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/EC2SecurityGroup/Resource
  EC2SecurityGroupfromAbexInfraStackFlagrSecurityGroupCC67624C22A5F2244A:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      Description: Allow SSH access from Flagr
      FromPort: 22
      GroupId:
        Fn::GetAtt:
          - EC2SecurityGroup05DEE054
          - GroupId
      SourceSecurityGroupId:
        Fn::GetAtt:
          - FlagrSecurityGroup0A74BC80
          - GroupId
      ToPort: 22
    Metadata:
      aws:cdk:path: AbexInfraStack/EC2SecurityGroup/from AbexInfraStackFlagrSecurityGroupCC67624C:22
  FlagrSecurityGroup0A74BC80:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: AbexInfraStack/FlagrSecurityGroup
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow incoming traffic to the Flagr server container
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrSecurityGroup/Resource
  FlagrECSClusterF4C1CFF1:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: flagr-ecs-cluster
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrECSCluster/Resource
  FlagrTaskDefTaskRole3A16C889:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrTaskDef/TaskRole/Resource
  FlagrTaskDefBD175F81:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
        - Environment:
            - Name: DATABASE_HOST
              Value:
                Fn::GetAtt:
                  - FlagrDatabaseD49A4237
                  - Endpoint.Address
            - Name: DATABASE_PORT
              Value:
                Fn::GetAtt:
                  - FlagrDatabaseD49A4237
                  - Endpoint.Port
            - Name: DATABASE_NAME
              Value: mydatabase
            - Name: DATABASE_USERNAME
              Value: myuser
            - Name: DATABASE_PASSWORD
              Value: mypassword
            - Name: DB_HOST
              Value:
                Fn::GetAtt:
                  - FlagrDatabaseD49A4237
                  - Endpoint.Address
            - Name: DB_PORT
              Value:
                Fn::GetAtt:
                  - FlagrDatabaseD49A4237
                  - Endpoint.Port
            - Name: DB_USERNAME
              Value: myuser
            - Name: DB_PASSWORD
              Value: mypassword
          Essential: true
          Image: myflagrserver:latest
          MountPoints:
            - ContainerPath: /var/lib/flagr
              ReadOnly: false
              SourceVolume: flagr-data
          Name: FlagrContainer
          PortMappings:
            - ContainerPort: 80
              Protocol: tcp
            - ContainerPort: 80
              Protocol: tcp
      Cpu: "512"
      Family: AbexInfraStackFlagrTaskDefBF1B3A55
      Memory: "1024"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn:
        Fn::GetAtt:
          - FlagrTaskDefTaskRole3A16C889
          - Arn
      Volumes:
        - Host:
            SourcePath: /mnt/efs/flagr-data
          Name: flagr-data
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrTaskDef/Resource
  MyECSServiceA46D38D8:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Ref: FlagrECSClusterF4C1CFF1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: 1
      EnableECSManagedTags: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - Fn::GetAtt:
                - MyECSServiceSecurityGroup438921E7
                - GroupId
          Subnets:
            - Ref: FlagrVpcPrivateSubnet1Subnet8C355231
            - Ref: FlagrVpcPrivateSubnet2SubnetD5FF51AE
      TaskDefinition:
        Ref: FlagrTaskDefBD175F81
    Metadata:
      aws:cdk:path: AbexInfraStack/MyECSService/Service
  MyECSServiceSecurityGroup438921E7:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: AbexInfraStack/MyECSService/SecurityGroup
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/MyECSService/SecurityGroup/Resource
  MyECSServiceSecurityGroupfromAbexInfraStackFlagrSecurityGroupCC67624C80543F073D:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      Description: Allow traffic from Flagr security group
      FromPort: 80
      GroupId:
        Fn::GetAtt:
          - MyECSServiceSecurityGroup438921E7
          - GroupId
      SourceSecurityGroupId:
        Fn::GetAtt:
          - FlagrSecurityGroup0A74BC80
          - GroupId
      ToPort: 80
    Metadata:
      aws:cdk:path: AbexInfraStack/MyECSService/SecurityGroup/from AbexInfraStackFlagrSecurityGroupCC67624C:80
  FlagrDatabaseSubnetGroup4541A8BD:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for FlagrDatabase database
      SubnetIds:
        - Ref: FlagrVpcPrivateSubnet1Subnet8C355231
        - Ref: FlagrVpcPrivateSubnet2SubnetD5FF51AE
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrDatabase/SubnetGroup/Default
  FlagrDatabaseSecurityGroup825D591D:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for FlagrDatabase database
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrDatabase/SecurityGroup/Resource
  FlagrDatabaseSecurityGroupfromAbexInfraStackFlagrSecurityGroupCC67624CIndirectPortAB36BEC8:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      Description: from AbexInfraStackFlagrSecurityGroupCC67624C:{IndirectPort}
      FromPort:
        Fn::GetAtt:
          - FlagrDatabaseD49A4237
          - Endpoint.Port
      GroupId:
        Fn::GetAtt:
          - FlagrDatabaseSecurityGroup825D591D
          - GroupId
      SourceSecurityGroupId:
        Fn::GetAtt:
          - FlagrSecurityGroup0A74BC80
          - GroupId
      ToPort:
        Fn::GetAtt:
          - FlagrDatabaseD49A4237
          - Endpoint.Port
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrDatabase/SecurityGroup/from AbexInfraStackFlagrSecurityGroupCC67624C:{IndirectPort}
  FlagrDatabaseD49A4237:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: "20"
      AutoMinorVersionUpgrade: true
      BackupRetentionPeriod: 7
      CopyTagsToSnapshot: true
      DBInstanceClass: db.t3.small
      DBSubnetGroupName:
        Ref: FlagrDatabaseSubnetGroup4541A8BD
      DeletionProtection: false
      Engine: postgres
      EngineVersion: "13.3"
      MasterUsername: myuser
      MasterUserPassword: mypassword
      MultiAZ: true
      PubliclyAccessible: false
      StorageType: gp2
      VPCSecurityGroups:
        - Fn::GetAtt:
            - FlagrDatabaseSecurityGroup825D591D
            - GroupId
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrDatabase/Resource
  FlagrServiceLBE25023C1:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: "false"
      Scheme: internet-facing
      SecurityGroups:
        - Fn::GetAtt:
            - FlagrServiceLBSecurityGroup9EF2DE5D
            - GroupId
      Subnets:
        - Ref: FlagrVpcPublicSubnet1SubnetA8AAC09A
        - Ref: FlagrVpcPublicSubnet2SubnetA0A535ED
      Type: application
    DependsOn:
      - FlagrVpcPublicSubnet1DefaultRouteF89EF665
      - FlagrVpcPublicSubnet1RouteTableAssociation27590502
      - FlagrVpcPublicSubnet2DefaultRouteAE600C29
      - FlagrVpcPublicSubnet2RouteTableAssociationAB67B60B
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/LB/Resource
  FlagrServiceLBSecurityGroup9EF2DE5D:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Automatically created Security Group for ELB AbexInfraStackFlagrServiceLB3D2589EF
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 80
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/LB/SecurityGroup/Resource
  FlagrServiceLBSecurityGrouptoAbexInfraStackFlagrServiceSecurityGroup985641BD80ECC67FF6:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId:
        Fn::GetAtt:
          - FlagrServiceLBSecurityGroup9EF2DE5D
          - GroupId
      IpProtocol: tcp
      Description: Load balancer to target
      DestinationSecurityGroupId:
        Fn::GetAtt:
          - FlagrServiceSecurityGroup07D05563
          - GroupId
      FromPort: 80
      ToPort: 80
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/LB/SecurityGroup/to AbexInfraStackFlagrServiceSecurityGroup985641BD:80
  FlagrServiceLBPublicListener6CB0D52A:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: FlagrServiceLBPublicListenerECSGroup5CDFA819
          Type: forward
      LoadBalancerArn:
        Ref: FlagrServiceLBE25023C1
      Port: 80
      Protocol: HTTP
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/LB/PublicListener/Resource
  FlagrServiceLBPublicListenerECSGroup5CDFA819:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 80
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: "false"
      TargetType: ip
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/LB/PublicListener/ECSGroup/Resource
  FlagrService0AE0DE87:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Ref: FlagrECSClusterF4C1CFF1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: 1
      EnableECSManagedTags: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: FlagrContainer
          ContainerPort: 80
          TargetGroupArn:
            Ref: FlagrServiceLBPublicListenerECSGroup5CDFA819
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - Fn::GetAtt:
                - FlagrServiceSecurityGroup07D05563
                - GroupId
          Subnets:
            - Ref: FlagrVpcPrivateSubnet1Subnet8C355231
            - Ref: FlagrVpcPrivateSubnet2SubnetD5FF51AE
      ServiceName: flagrserver
      TaskDefinition:
        Ref: FlagrTaskDefBD175F81
    DependsOn:
      - FlagrServiceLBPublicListenerECSGroup5CDFA819
      - FlagrServiceLBPublicListener6CB0D52A
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/Service/Service
  FlagrServiceSecurityGroup07D05563:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: AbexInfraStack/FlagrService/Service/SecurityGroup
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: from 0.0.0.0/0:80
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Ref: FlagrVpc7D9A1759
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/Service/SecurityGroup/Resource
  FlagrServiceSecurityGroupfromAbexInfraStackFlagrServiceLBSecurityGroup229759CC802EB0661F:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      Description: Load balancer to target
      FromPort: 80
      GroupId:
        Fn::GetAtt:
          - FlagrServiceSecurityGroup07D05563
          - GroupId
      SourceSecurityGroupId:
        Fn::GetAtt:
          - FlagrServiceLBSecurityGroup9EF2DE5D
          - GroupId
      ToPort: 80
    Metadata:
      aws:cdk:path: AbexInfraStack/FlagrService/Service/SecurityGroup/from AbexInfraStackFlagrServiceLBSecurityGroup229759CC:80
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAA/31Sy07DMBD8Fu6ueRxAHEsLqBKCqK24oo2zlKWpHdnrIBTl31knhISHOHl2PPaOZ32mLy71yRG8hZkp9rOSct1sGMxeCfXUoDnTzWNl1OLZPmYLlcW8JLOJuUVO3IjWLjJuIS9x5EduHoIzBEzOfokTuF5labkHvgXGN3hXmada4HjxyjJ6wYOgd/JZzVm8vhzQstqgiZ74/da7WHUe/iVWducxhF/8dUe3Ck3QzaKMQbon0QC3EPZLfCZLw2N+Ms4ykEU/4W7A79Kj0Ndk+oB62CqCg27Wro8tra3yhbReAkMOAVc2MFg51Cfy9Zjl1S9ikHbmnyrgFFzQ86qSmXXZ3zkorqBMouKHJywhMJlSFHmnILurZfh/n+4i+VZPdSRJ2U/NgCf7W+k8MT4p21atMbjoU0iStzuMpaTz91bmXU1FahECsnzenVhP+ofIVez+kMyk6CbRKusK1K/huD491yfy818D0cxHy3RAve7XDwBqgf8VAwAA
    Metadata:
      aws:cdk:path: AbexInfraStack/CDKMetadata/Default
    Condition: CDKMetadataAvailable
Outputs:
  FlagrServiceLoadBalancerDNSDC2459A8:
    Value:
      Fn::GetAtt:
        - FlagrServiceLBE25023C1
        - DNSName
  FlagrServiceServiceURL6BDAB979:
    Value:
      Fn::Join:
        - ""
        - - http://
          - Fn::GetAtt:
              - FlagrServiceLBE25023C1
              - DNSName
Conditions:
  CDKMetadataAvailable:
    Fn::Or:
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - af-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ca-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-northwest-1
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-2
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-3
          - Fn::Equals:
              - Ref: AWS::Region
              - me-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - sa-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-2
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-2
Parameters:
  BootstrapVersion:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /cdk-bootstrap/hnb659fds/version
    Description: Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]
Rules:
  CheckBootstrapVersion:
    Assertions:
      - Assert:
          Fn::Not:
            - Fn::Contains:
                - - "1"
                  - "2"
                  - "3"
                  - "4"
                  - "5"
                - Ref: BootstrapVersion
        AssertDescription: CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.
```
